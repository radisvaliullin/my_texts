# Просто о Биткоин, блокчейн.

Цель данной статьи максимально просто объяснить что такое Биткойн, блокчейн, тем кто плохо представляет как устроен компьютер, интернет, базы данных, криптография, электронно-цифровая подпись и т.п., без искажения сути и базовой идеи лежащей в основе данной технологии. Она так же будет полезна и тем кто вроде знает как устроен биткойн, мой опыт показывает что многие путают/не понимают зачем нужен блокчейн в биткойне.

Биткойн - это децентрализованная (без единого центра/управляющего органа) электронная платежная система, с внутренней одноименной валютой (биткойн, BTC), работающая через интернет. Биткойн как и любая другая платежная система (paypal, yandex money, коммерческие банки и т.п.) позволяет пользователям иметь счета (в биткойн) и совершать переводы между счетами.

В 2008 сообщество Биткойн публикует свой манифест "Bitcoin: A Peer-to-Peer Electronic Cash System" / "Биткойн: электронная денежная система с равноправными участниками" под псевдонимом Сатоши Накомото. Цель проекта предоставить людям электронную валюту и платежную систему работающую минуя существующие финансовые институты (в лице гос-ва, банков, и т.п.). Так же система должна обеспечивать приватность персональных данных пользователей.

Децентрализация против централизации.

Давайте разберемся с тем что такое децентрализованная система в сравнении с централизованной на примере компьютерной сети. В централизованной сети есть центральный сервер (например сервер банка) и компьютеры пользователей. Когда вы со своего телефона или домашнего компьютера выполняете какую-то операцию в онлайн банкинге, то все запросы поступают на сервера банка и происходит проверка корректности всех ваших действий, валидные операции обрабатываются, а не валидные откланяются. Таким образом ответственность за надлежащее функционирование сети возлагается на банк (доверенный центр), от вас же требуется только уметь этим пользоваться. В децентрализованной модели, у вас нет выделенного сервера, все компьютеры участников равноправны, каждый компьютер выполняет функции сервера (банка) и пользователя одновременно, ответственность за работоспособность сети распределяется по всем участникам поровну. На первый взгляд это кажется сложным и не работоспособным, но децентрализованные сети были и до биткойна, есть и сейчас (правда они не очень востребованы среди широких масс). Работоспособность распределенной модели строится на том что подавляющее большинство участников честны и готовы следовать правилам, а технические средства должны обеспечивать эффективную защиту от недоброжелательных пользователей.

Что бы было проще давайте сравним биткойн (децентрализованную сеть) с работой традиционных банков (моделью централизованной сети с доверительным центром, которому все доверяют). Мы будем постепенно шаг за шагом описывать отдельные компоненты, а потом в конце объединим все в единое целостное описание биткойн сети.

Кратко о банках

Центробанк печатает деньги (эмиссия) согласно законам и денежной политике гос-ва. Далее ЦБ кредитует крупные коммерческие банки, те в свою очередь средние и мелкие. Банки кредитуют бизнес и людей. Бизнес и люди осуществляют товаро-денежный обмен. Банки и другие платежные системы предоставляют удобные инструменты для безналичного расчета. Так же гос-во предоставляет паспорта, уникальный идентификатор гражданина, по которому можно в банке открыть счет и управлять этим счетом. Это упрощенное дилетантское описание, но вполне приемлемое для нас.

Как выше описанные функции решает децентрализованная система Биткойн, а именно:

- как биткойн печатает деньги, без доверенного центра, и как они распределяются по участникам?
- как в биткоине организованны счета людей, при этом так что бы не требовалось предоставлять никаких персональных данных (паспортные и прочие данные) владельца счета, пользователь оставался приватным/анонимным, при этом что бы владелец мог управлять и контролировать своим счетом и только он?
- как переводить деньги между анонимными счетами?
- и самая сложная задача, которую долгое время не удавалось решить, как в децентрализованной сети решить проблему двойной траты (забегая вперед как раз ее и решает блокчейн)?

Проблема Двойной траты

Представьте себе что у вас на счету вашего банка есть 100 рублей. Вы заходите с двух телефонов в мобильный банк и с каждого из устройств одновременно делаете покупку на 100 рублей. Создаются две транзакции (платежа) превышающие в сумме баланс на вашем счету. Возникает вопрос а какая из этих операций верная. В централизованной системе все просто, как только два запроса придут на сервера банка (интернет не гарантирует в каком порядке придут эти запросы), банк и разрешит спорный вопрос, обработает одну из транзакций а вторую отклонит как превышающую ваш баланс, главное что вы не сможете потратить больше чем у вас есть.  

В децентрализованной системе все сложнее (вы наверное и так уже догадались). Состояние вашего счета храниться у вас и у всех участников сети (пока опустим каким образом). У вас на счету 100 биткоинов (BTC). Вы создаете два платежа по 100 BTC двум разным участникам (назовем их транзакции Tx1 и Tx2), и эти два платежа отправляете (каждый платеж отдельным запросом) всем участникам сети, что бы у всех была актуальная информация. Как уже говорилось интернет не гарантирует в каком порядке эти два запроса придут каждому из участников, и так может случится что половине участников придет в одном порядке (Tx1, Tx2) а другой в другом (Tx2, Tx1), и тогда возникает ситуация когда половина сети будет считать первой Tx1 а другая Tx2, произойдет рассогласование состояния сети. Может случится так что каждому из двух получателей платежа может прийти первым его платеж и тогда они могут отравить товар покупателю, решив что их платеж прошел, произойдет двойная трата, за одни и те же 100 биткоинов произойдет покупка двух товаров. Даже если получатели запросят подтверждения порядка еще у кого то из участников, нет гарантии что они запросят у участников с отличающимся порядком, только если не запросить у всех, а это слишком накладно и все равно не решает проблему правильного порядка транзакций. Как оказалось это не тривиальная задача, на решение которой у энтузиастов криптовалют ушло много лет. Но давайте разбираться по порядку.

Эмиссия биткойна.

Цифровые деньги, например те что на счетах ваших банковских карт, это просто записи (байтов) в базе данных на серверах банков (в компьютере вообще любая информация это просто байты на жестком диске, а базы данных это всего лишь структурированные определенным образом байты, ну что то типа табличек в excel). "Печатание" денег это ни что иное как создание записей в базе данных, что такая то сумма "напечатана". Важно отметить что печатание денег должно подчинятся определенным правилам иначе такие деньги не будут представлять ценности (например важно количество печатаемых денег). Как правило за этим следят центробанки.

Криптовалюта, как и другие цифровые деньги, это не более чем записи в базе данных, но не на централизованных серверах а на компьютерах участников децентрализованной сети. Так же есть правила регламентирующие объем "печатаемых" биткоинов и их распределение по счетам участников, но в отличие от централизованной модели за соблюдением правил следят все участники системы.

Как это выглядит. В Биткойн сети каждые десять минут создаётся блок блокчейна (пока не важно что это за блоки, скажем лишь что блоки хранят порядок транзакций, и это тоже всего лишь записи в базе данных), за его создание его создателю (им может быть любой участник) в качестве вознаграждения за обслуживание системы начисляется 12,5 биткоинов, путем их "печатания" и зачисления на счет создателя блока, то есть каждые 10 минут эмитируются 12,5 биткоинов и это единственный способ их печати. Изначально вознаграждение было 50 BTC но через 210 000 блоков (около 4 лет) вознаграждение уменьшается в двое, что бы общее кол-во биткоинов не превысило 21 млн. Так как общее кол-во биткоинов ограниченно, биткойн это дефляционная валюта.

Счета и переводы (транзакции)

Давайте поговорим теперь как устроенны счета на которые зачисляются эмитированные биткоины и как можно переводить биткоины между счетами участников, оплачивая товары, услуги или просто удовольствия ради.

Как уже говорилось каждый участник системы имеет у себя полную копию базы биткоина со всеми счетами и транзакциями. Как в такой системе где есть доступ у всех ко всему оформить владение счетом, без привязки к каким либо данным пользователя, оставляя при этом возможность только владельцу тратить деньги со своего счета? Это решается с помощью технологии называемой электронно цифровая подпись. Давайте немного поговорим о ней.

Электронно цифровая подпись (ЭЦП).

Мы не будем разбирать технические особенности устройства ЭЦП, опишем только принцип работы. У ЭЦП есть два ключа (как и все в компьютере это всего лишь набор байтов), один секретный/приватный, как следует из названия его нельзя сообщать никому, его должен знать только владелец ЭЦП (и хранить только на своем компьютере), а второй открытый/публичный, его можно сообщать всем. ЭЦП устроен так что с помощью секретного ключа и только с его помощью можно создать ЭЦП для любого документа (как ЭЦП так и подписываемый документ это всего лишь байты), а с помощью открытого ключа всегда можно проверить достоверность подписи (если изменится хотя бы один бит документа, ЭЦП не пройдет проверку).

Открытый ключ в биткоине используется как номер счета. Тогда владелец счета может создать запись вида "счет такой то, на счет такой то, перевести столько то BTC", и подписать данный документ (транзакцию) своим секретным ключом. Это очень похоже на подписывание чека из чековой книжки, так знакомый нам по американским фильмам, принцип тот же. И разослать эту транзакцию всем участникам. Далее любой кто получит транзакцию, смотрит на счет отравителя, он же открытый ключ владельца счета и проверяет ЭЦП, если все верно, подпись валидна, все понимают что транзакция создана владельцем счета, так как только у него есть секретный ключ, все просто и без раскрытия персональных данных. Согласитесь красиво. Собственно в Биткойне нет как такового счета, есть только подписанные транзакции, а состояние счета это разница между полученными деньгами и потраченными. База биткоина хранит историю всех транзакций, поэтому мы всегда можем посчитать текущее состояние счета. Есть два типа транзакций: это транзакция с переводом между счетами, и вы не можете создавать транзакции тратящие больше чем у вас есть; а второй тип транзакции это эмиссионная с вознаграждением за создание блока, у нее нет отправителя только получатель.

И так у нас есть транзакции защищенные ЭЦП и состояние счета как разница между приходом и расходом, все вроде бы хорошо, но у нас остается проблема двойной траты. Не что не мешает нам создавать сколько угодно транзакций, а как говорилось интернет не гарантирует что транзакции до всех дойдут с одинаковой скоростью, и так может случиться что несколько участников получат транзакции подтверждающие перевод на их счета, они проверят ЭЦП, убедятся что транзакция не тратит больше чем есть у вас уже на счету и отгрузят товар, а только потом заметят что вы насоздавали еще несколько транзакций превышающие ваш баланс. ЭЦП подтверждает что это ваша транзакция но не защищает от создания копий, эту проблему призвано решить идея блокчейн.

Блокчейн

Нужно как то упорядочить транзакции, тогда как и в централизованной системе будет понятна очередность списания денег со счета и понятно какие транзакции не проходят. Казалось бы можно в транзакции сохранять временную метку, но не что не мешает ее подделать создателю платежа. Решение такое, нужно с какой то периодичностью собирать все новые транзакции в блок (блок это всего лишь запись о порядке транзакций), добавляя проверять подпись и что транзакция не тратит больше чем есть на счету с учетом уже включенных транзакций в блок. Затем через какое то время фиксировать блок и отсылать его всем остальным участникам. Каждый новый блок ссылается на предыдущий образуя таким образом цепочку блоков (блокчейн), хранящую историю транзакций и задающая их порядок. Так же каждый блок хранит информацию о предыдущем блоке в виде хеша (не вдаваясь в технические детали хеша, скажем только что он позволяет проверить менялось ли содержимое блока или нет), защищая старые блоки от изменений в будущем (подробнее чуть позже).

Сам по себе блок не решает проблему двойной траты, так как ни что не мешает создать два блока с двойной транзакцией в каждом (ну собственно проблема двойной траты возникает из-за того, что создание копий в цифровом мире ничего ни стоит). Проблему решает идея названная "доказательство работой", суть в том что бы блок нельзя было создать простым копированием, а нужно было потратить какое то время решая вычислительную задачу, которая подбирается так что бы в среднем уходило 10 мин на поиск ответа. Причем задача такая, что решение проверялось "быстро", а вот поиск ответа долго (10 мин), а еще что бы шанс найти ответ имел случайный характер, что бы все имели шанс на его нахождение, не будем вдаваться в детали скажем лишь что математика и компьютер нам такое позволяют.

Таким образом если кто то хочет создать два блока то у него меньше шансов (так как в среднем ему нужно будет 20 мин по 10 на блок) чем у честных участников, но даже если ему это удастся (все зависит от мощности компьютера) то будет ситуация где наш блокчейн раздвоится на два блока в конце. Как быть? Шанс что злоумышленнику удастся это еще раз очень мал, и будет падать с каждым новым блоком. Поэтому скорее всего следующий блок будет создан другим участником, он выберет к какому из двух блоков нужно добавить свой блок, тогда один из путей в раздвоенной цепочке станет длинней, а правило такое что верным является длиннейшая цепочка в блокчейне, короткая цепочка будет отброшена участниками как не действительная. Вот так и решается проблема двойной траты. Вуаля.

Суммируем и рассмотрим как это все работает в целом.

Основные правила (протокол) сети Биткойн:
- Каждые 10 мин создается блок, как хранилище упорядоченных транзакций. Блок защищен алгоритмом "доказательство работы", требующий произвести некоторые вычисления для создания блока, делая генерацию блока "дорогим", что предотвращает от легкого создания ложных блоков, что в свою очередь защищает от проблемы двойной траты;
- Новый блок соединяется с предыдущим блоком, образуя цепочку блокчейн хранящею очередность всей истории транзакций. Каждый блок хранит хэш предыдущего блока, для защиты от изменения/подделки старых блоков по цепочке;
- Консенсусное правило требует считать действительной длиннейшею из цепочек, если у разных участников образуется разные версии блоков (блокчейн раздвоится на подцепочки, такое возможно например если злоумышленники попытаются переписать историю блоков с целью подделать транзакции). Пока честные участники образуют большинство в сети Блокчейн и имеют в сумме большие вычислительные мощности, и с учетом того что создание блока требует "доказательство вычислением", тогда длиннейшая цепочка блоков будет строится добросовестными участниками, и она будет содержать достоверные данные;
- В создание блока может принимать участие любой желающий. Если ваш блок окажется в  итоге в длиннейшей цепочке, то такой блок считается действительным. За создание блока участник получает вознаграждение эмитированными биткоинами. Это единственный способ создания биткойн валюты. Биткойн эмитируется создателем блока, путем создания транзакции у которой есть только получатель сам создатель блока, эта транзакция всегда является первой транзакцией в списке транзакций блока.

Смоделируем работу Блокчейн сети для полной ясности.

Допустим в начале системы был только одни участник, он каждые 10 минут создает один блок и добавляет его в конец предыдущего, само собой есть первый блок который никуда не добавляется. За каждый блок он себе дарит 50 BTC эмитируя новые биткоины (потом эта сумма уменьшится до 12,5 как сейчас и будет уменьшатся дальше). Он так же может добавлять в блок транзакции переводя сам себе биткоины, но блоки могут быть и без транзакций (ну кроме эмиссионной). Он публикует в интернете что создал такую крутую вещь и через неделю в сети уже 100 человек. Теперь 100 человек конкурируют в создании блока, если хотят, это не обязательно, можно просто иметь счета и делать только транзакции. Допустим один из них злоумышленник или вандал. Если он будет генерировать бессмысленные транзакции, то они будут просто откланяться как невалидные, если же он попытается провести двойную трату (можно это сравнить с фальшивомонетничеством) то нас защитит блокчейн с концепцией "доказательство работой".

Это статья еще в не окончательной версии, она в процессе. В этой статье опущены многие интересные технические подробности раскрывающие те или иные подробности, возможно они будут добавлены в будущем в виде сносок. А так общая идея, показывающая красоту замысла раскрыта.

Возможно будет статья объясняющая таки почему биткоин это тоже деньги, хотя многие и оспаривают.

Всем спасибо. Пока.
